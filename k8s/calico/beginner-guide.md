# Calico åˆçº§å­¦ä¹ æŒ‡å— (1-2å‘¨)

> æœ¬æ–‡æ¡£ä¸“ä¸º Calico åˆå­¦è€…è®¾è®¡ï¼Œæ¶µç›–åŸºç¡€æ¦‚å¿µåˆ°å®è·µæ“ä½œçš„å®Œæ•´å­¦ä¹ è·¯å¾„

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡1-2å‘¨çš„å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š
- Kubernetes ç½‘ç»œæ¨¡å‹åŸºç¡€
- CNI (Container Network Interface) åŸºæœ¬æ¦‚å¿µ
- Calico çš„å®‰è£…å’ŒåŸºæœ¬é…ç½®
- Pod é—´ç½‘ç»œé€šä¿¡çš„å®è·µæ“ä½œ

## ğŸ“š ç¬¬ä¸€å‘¨ï¼šç†è®ºåŸºç¡€

### Day 1-2: Kubernetes ç½‘ç»œæ¨¡å‹

#### ğŸ“– æ ¸å¿ƒæ¦‚å¿µ
Kubernetes ç½‘ç»œæ¨¡å‹éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
- **æ‰å¹³ç½‘ç»œ**: æ‰€æœ‰ Pod éƒ½åœ¨ä¸€ä¸ªæ‰å¹³çš„ç½‘ç»œç©ºé—´ä¸­
- **æ—  NAT é€šä¿¡**: Pod ä¹‹é—´å¯ä»¥ç›´æ¥é€šä¿¡ï¼Œæ— éœ€ NAT
- **å”¯ä¸€ IP**: æ¯ä¸ª Pod éƒ½æœ‰å”¯ä¸€çš„é›†ç¾¤å†… IP åœ°å€

#### ğŸ” æ·±å…¥ç†è§£ï¼šä¸ºä»€ä¹ˆ Kubernetes å¯ä»¥å®ç°æ—  NAT é€šä¿¡ï¼Ÿ

**æ—  NAT é€šä¿¡**æ˜¯ Kubernetes ç½‘ç»œæ¨¡å‹çš„å…³é”®ç‰¹æ€§ï¼Œè¿™æ„å‘³ç€ Pod ä¹‹é—´çš„é€šä¿¡ä¸éœ€è¦ç½‘ç»œåœ°å€è½¬æ¢ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£å…¶æŠ€æœ¯åŸç†ï¼š

##### 1. **ä»€ä¹ˆæ˜¯ NATï¼Ÿä¸ºä»€ä¹ˆè¦é¿å…å®ƒï¼Ÿ**

**NAT (Network Address Translation) çš„é—®é¢˜ï¼š**
```
ä¼ ç»Ÿ NAT é€šä¿¡æµç¨‹ï¼š
Pod-A (ç§æœ‰IP: 192.168.1.10:8080) 
    â†“
NAT ç½‘å…³ (è½¬æ¢ä¸ºå…¬ç½‘IP: 203.0.113.1:30001)
    â†“ (é€šè¿‡äº’è”ç½‘)
NAT ç½‘å…³ (è½¬æ¢å›ç§æœ‰IP: 192.168.2.1:8080)
    â†“
Pod-B (ç§æœ‰IP: 192.168.2.20:8080)

é—®é¢˜ï¼š
- IP åœ°å€è¢«è½¬æ¢ï¼Œåº”ç”¨æ— æ³•è·å¾—çœŸå®çš„æº IP
- ç«¯å£æ˜ å°„å¤æ‚ï¼Œéœ€è¦é¢å¤–çš„ç«¯å£ç®¡ç†
- è¿æ¥çŠ¶æ€è·Ÿè¸ªå¼€é”€å¤§
- æŸäº›åè®®ï¼ˆå¦‚ FTPã€SIPï¼‰ä¸å…¼å®¹ NAT
```

##### 2. **Kubernetes å¦‚ä½•å®ç°æ—  NAT é€šä¿¡ï¼Ÿ**

**æ ¸å¿ƒåŸç†ï¼šå…¨å±€è·¯ç”±è¡¨ + ç›´æ¥è·¯ç”±**

```
Pod-A (10.244.1.10:8080) â†ç›´æ¥è·¯ç”±â†’ Pod-B (10.244.2.20:8080)

æ— éœ€åœ°å€è½¬æ¢ï¼æº IP å’Œç›®æ ‡ IP éƒ½ä¿æŒä¸å˜
```

**æŠ€æœ¯å®ç°æ­¥éª¤ï¼š**

**A. é›†ç¾¤çº§ IP åœ°å€åˆ†é…**
```bash
# æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘æ®µ
èŠ‚ç‚¹ A: 10.244.1.0/24  (å¯åˆ†é… 254 ä¸ª Pod IP)
èŠ‚ç‚¹ B: 10.244.2.0/24  (å¯åˆ†é… 254 ä¸ª Pod IP)
èŠ‚ç‚¹ C: 10.244.3.0/24  (å¯åˆ†é… 254 ä¸ª Pod IP)

# Pod è·å¾—é›†ç¾¤å†…å…¨å±€å”¯ä¸€çš„ IP
Pod-A: 10.244.1.10  (åœ¨èŠ‚ç‚¹ A)
Pod-B: 10.244.2.20  (åœ¨èŠ‚ç‚¹ B)
```

**B. è‡ªåŠ¨è·¯ç”±åˆ†å‘æœºåˆ¶**
```bash
# å½“ Pod åˆ›å»ºæ—¶ï¼ŒCalico è‡ªåŠ¨æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„è·¯ç”±è¡¨

# èŠ‚ç‚¹ A çš„è·¯ç”±è¡¨
10.244.1.0/24 dev cali123abc scope link  # æœ¬åœ° Pod
10.244.2.0/24 via 192.168.100.101       # åˆ°èŠ‚ç‚¹ B çš„è·¯ç”±
10.244.3.0/24 via 192.168.100.102       # åˆ°èŠ‚ç‚¹ C çš„è·¯ç”±

# èŠ‚ç‚¹ B çš„è·¯ç”±è¡¨  
10.244.2.0/24 dev cali456def scope link  # æœ¬åœ° Pod
10.244.1.0/24 via 192.168.100.100       # åˆ°èŠ‚ç‚¹ A çš„è·¯ç”±
10.244.3.0/24 via 192.168.100.102       # åˆ°èŠ‚ç‚¹ C çš„è·¯ç”±
```

**C. BGP åè®®è‡ªåŠ¨åŒæ­¥**
```
èŠ‚ç‚¹ A â†â†’ BGP ä¼šè¯ â†â†’ èŠ‚ç‚¹ B
   â†“                    â†“
"æˆ‘æœ‰ 10.244.1.0/24"   "æˆ‘æœ‰ 10.244.2.0/24"
   â†“                    â†“
è‡ªåŠ¨å­¦ä¹ å¹¶æ›´æ–°è·¯ç”±è¡¨
```

##### 3. **æ•°æ®åŒ…ä¼ è¾“çš„å®Œæ•´æµç¨‹**

```
å‘é€ç«¯ (Pod-A: 10.244.1.10)
    â†“
1. åº”ç”¨å‘é€æ•°æ®ï¼šsrc=10.244.1.10:8080, dst=10.244.2.20:8080
    â†“
2. å†…æ ¸æŸ¥è·¯ç”±è¡¨ï¼š10.244.2.0/24 via 192.168.100.101
    â†“
3. å°è£…ä»¥å¤ªç½‘å¸§ï¼šdst_mac=èŠ‚ç‚¹Bçš„MACåœ°å€
    â†“
4. ç‰©ç†ç½‘ç»œä¼ è¾“åˆ°èŠ‚ç‚¹ B
    â†“
5. èŠ‚ç‚¹ B æ¥æ”¶å¹¶æŸ¥è·¯ç”±ï¼š10.244.2.20 dev cali456def
    â†“
6. ç›´æ¥è½¬å‘åˆ° Pod-B
    â†“
æ¥æ”¶ç«¯ (Pod-B: 10.244.2.20) æ”¶åˆ°åŸå§‹ IP åŒ…
```

**å…³é”®ç‚¹ï¼šæ•´ä¸ªè¿‡ç¨‹ä¸­æº IP å’Œç›®æ ‡ IP ä»æœªæ”¹å˜ï¼**

##### 4. **ä¸ NAT æ–¹å¼çš„å¯¹æ¯”**

| ç‰¹æ€§ | Kubernetes æ—  NAT | ä¼ ç»Ÿ NAT ç½‘ç»œ |
|------|------------------|---------------|
| **æº IP ä¿æŒ** | âœ… å®Œå…¨ä¿æŒ | âŒ è¢«è½¬æ¢ |
| **ç«¯å£å†²çª** | âœ… æ— å†²çª | âŒ éœ€è¦ç«¯å£æ˜ å°„ |
| **åè®®æ”¯æŒ** | âœ… æ‰€æœ‰åè®® | âŒ æŸäº›åè®®å—é™ |
| **æ€§èƒ½å¼€é”€** | âœ… ç›´æ¥è·¯ç”±ï¼Œä½å»¶è¿Ÿ | âŒ NAT è½¬æ¢å¼€é”€ |
| **è¿æ¥è·Ÿè¸ª** | âœ… æ— éœ€çŠ¶æ€è¡¨ | âŒ éœ€è¦ç»´æŠ¤è¿æ¥çŠ¶æ€ |
| **åŒå‘é€šä¿¡** | âœ… å¯¹ç­‰é€šä¿¡ | âŒ éœ€è¦ç«¯å£è½¬å‘é…ç½® |

##### 5. **å®é™…éªŒè¯æ—  NAT é€šä¿¡**

**éªŒè¯å‘½ä»¤ï¼š**
```bash
# 1. åˆ›å»ºä¸¤ä¸ªæµ‹è¯• Pod
kubectl run pod-a --image=nicolaka/netshoot --command -- sleep 3600
kubectl run pod-b --image=nicolaka/netshoot --command -- sleep 3600

# 2. è·å– Pod IP
POD_A_IP=$(kubectl get pod pod-a -o jsonpath='{.status.podIP}')
POD_B_IP=$(kubectl get pod pod-b -o jsonpath='{.status.podIP}')

# 3. ä» Pod-A è®¿é—® Pod-Bï¼ŒæŸ¥çœ‹ç½‘ç»œåŒ…
kubectl exec pod-a -- tcpdump -i eth0 -n host $POD_B_IP &
kubectl exec pod-a -- ping -c 1 $POD_B_IP

# 4. éªŒè¯æº IP ä¿æŒä¸å˜
kubectl exec pod-b -- netstat -an | grep $POD_A_IP
```

**æœŸæœ›ç»“æœï¼š**
- Pod-B çœ‹åˆ°çš„è¿æ¥æº IP å°±æ˜¯ Pod-A çš„çœŸå® IP
- æ²¡æœ‰ä»»ä½•åœ°å€è½¬æ¢ç—•è¿¹

##### 6. **æ—  NAT çš„ä¸šåŠ¡ä»·å€¼**

**A. å®‰å…¨å®¡è®¡**
```bash
# åº”ç”¨å¯ä»¥è·å¾—çœŸå®çš„å®¢æˆ·ç«¯ IP
kubectl logs web-pod | grep "Client IP: 10.244.1.10"
# è€Œä¸æ˜¯çœ‹åˆ°ç½‘å…³çš„ IP
```

**B. æœåŠ¡å‘ç°ç®€åŒ–**
```yaml
# æœåŠ¡å¯ä»¥ç›´æ¥ä½¿ç”¨ Pod IP é€šä¿¡
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  clusterIP: None  # Headless Service
  selector:
    app: backend
```

**C. åè®®å…¼å®¹æ€§**
```bash
# æ”¯æŒéœ€è¦ç«¯åˆ°ç«¯è¿æ¥çš„åè®®
# å¦‚ gRPC åŒå‘æµã€WebSocketã€æ•°æ®åº“è¿æ¥æ± ç­‰
```

##### 7. **Calico çš„æ—  NAT å®ç°ç»†èŠ‚**

**veth pair + ç›´æ¥è·¯ç”±ï¼š**
```
Pod ç½‘ç»œå‘½åç©ºé—´
    â†“ (veth pair)
ä¸»æœºç½‘ç»œå‘½åç©ºé—´
    â†“ (ç›´æ¥è·¯ç”±ï¼Œæ—  bridge)
ç‰©ç†ç½‘å¡
    â†“ (BGP è·¯ç”±)
ç›®æ ‡èŠ‚ç‚¹
```

**ä¸å…¶ä»– CNI çš„å¯¹æ¯”ï¼š**
- **Flannel (VXLAN æ¨¡å¼)**: ä½¿ç”¨éš§é“å°è£…ï¼Œæœ‰é¢å¤–å¼€é”€
- **Flannel (host-gw æ¨¡å¼)**: ç±»ä¼¼ Calicoï¼Œç›´æ¥è·¯ç”±
- **Weave**: å¯é€‰æ‹©è·¯ç”±æˆ–éš§é“æ¨¡å¼
- **Calico**: é»˜è®¤ç›´æ¥è·¯ç”±ï¼Œæ€§èƒ½æœ€ä¼˜

è¿™å°±æ˜¯ Kubernetes å®ç°æ—  NAT é€šä¿¡çš„å®Œæ•´åŸç†â€”â€”é€šè¿‡å…¨å±€ IP åˆ†é… + è‡ªåŠ¨è·¯ç”±åˆ†å‘ + BGP åè®®åŒæ­¥ï¼Œå®ç°äº†çœŸæ­£çš„"æ‰å¹³ç½‘ç»œ"ï¼

#### ğŸ” æ·±å…¥ç†è§£ï¼šä¸ºä»€ä¹ˆè¯´ Kubernetes æ˜¯æ‰å¹³ç½‘ç»œï¼Ÿ

**æ‰å¹³ç½‘ç»œ (Flat Network)** æ˜¯ Kubernetes ç½‘ç»œæ¨¡å‹çš„æ ¸å¿ƒç‰¹å¾ï¼Œè¿™é‡Œçš„"æ‰å¹³"æœ‰ç€ç‰¹å®šçš„æŠ€æœ¯å«ä¹‰ï¼š

##### 1. **ç½‘ç»œæ‹“æ‰‘å±‚é¢çš„æ‰å¹³**
```
ä¼ ç»Ÿå¤šå±‚ç½‘ç»œæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚ (Layer 7)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ä¼šè¯å±‚ (Layer 5)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç½‘ç»œå±‚ (Layer 3)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ•°æ®é“¾è·¯å±‚ (Layer 2)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Kubernetes æ‰å¹³ç½‘ç»œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ‰€æœ‰ Pod åœ¨åŒä¸€ä¸ª IP ç½‘æ®µ        â”‚
â”‚    Pod-A(10.1.1.10) â†â†’ Pod-B(10.1.2.20) â”‚
â”‚         ç›´æ¥ä¸‰å±‚è·¯ç”±é€šä¿¡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### 2. **åœ°å€ç©ºé—´çš„æ‰å¹³åŒ–**
- **ç»Ÿä¸€åœ°å€ç©ºé—´**: æ•´ä¸ªé›†ç¾¤ä½¿ç”¨åŒä¸€ä¸ªå¤§çš„ IP åœ°å€ç©ºé—´ï¼ˆå¦‚ 10.244.0.0/16ï¼‰
- **æ— å­ç½‘éš”ç¦»**: Pod ä¸éœ€è¦é€šè¿‡ç½‘å…³æˆ– NAT å°±èƒ½ç›´æ¥è®¿é—®å…¶ä»– Pod
- **è·¯ç”±é€æ˜**: æ¯ä¸ª Pod éƒ½èƒ½"çœ‹åˆ°"é›†ç¾¤å†…æ‰€æœ‰å…¶ä»– Pod çš„çœŸå® IP

##### 3. **ä¸ä¼ ç»Ÿç½‘ç»œæ¶æ„çš„å¯¹æ¯”**

**ä¼ ç»Ÿè™šæ‹ŸåŒ–ç½‘ç»œï¼ˆéæ‰å¹³ï¼‰:**
```
VM-A (192.168.1.10) 
    â†“ (é€šè¿‡è™šæ‹Ÿäº¤æ¢æœº)
è™šæ‹Ÿç½‘å…³ (192.168.1.1)
    â†“ (NAT è½¬æ¢)
ç‰©ç†ç½‘ç»œ (10.0.0.0/8)
    â†“ (è·¯ç”±)
è™šæ‹Ÿç½‘å…³ (192.168.2.1)
    â†“ (é€šè¿‡è™šæ‹Ÿäº¤æ¢æœº)  
VM-B (192.168.2.20)
```

**Kubernetes æ‰å¹³ç½‘ç»œ:**
```
Pod-A (10.244.1.10) â†ç›´æ¥è·¯ç”±â†’ Pod-B (10.244.2.20)
```

##### 4. **æŠ€æœ¯å®ç°åŸç†**

æ‰å¹³ç½‘ç»œé€šè¿‡ä»¥ä¸‹æŠ€æœ¯å®ç°ï¼š

**A. é›†ç¾¤çº§åˆ«çš„è·¯ç”±è¡¨**
```bash
# èŠ‚ç‚¹ A çš„è·¯ç”±è¡¨
10.244.1.0/24 dev cali123abc scope link  # æœ¬èŠ‚ç‚¹ Pod
10.244.2.0/24 via 192.168.1.101        # èŠ‚ç‚¹ B çš„ Pod

# èŠ‚ç‚¹ B çš„è·¯ç”±è¡¨  
10.244.2.0/24 dev cali456def scope link  # æœ¬èŠ‚ç‚¹ Pod
10.244.1.0/24 via 192.168.1.100        # èŠ‚ç‚¹ A çš„ Pod
```

**B. BGP è·¯ç”±åè®®è‡ªåŠ¨åŒæ­¥**
```
èŠ‚ç‚¹ A â†â†’ BGP ä¼šè¯ â†â†’ èŠ‚ç‚¹ B
   â†“                    â†“
è‡ªåŠ¨å­¦ä¹ å¯¹æ–¹çš„Podè·¯ç”±ä¿¡æ¯
```

##### 5. **æ‰å¹³ç½‘ç»œçš„ä¼˜åŠ¿**

1. **ç®€åŒ–ç½‘ç»œæ¨¡å‹**: 
   - å¼€å‘è€…ä¸éœ€è¦è€ƒè™‘å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘
   - æœåŠ¡å‘ç°æ›´åŠ ç›´è§‚

2. **æ€§èƒ½ä¼˜åŠ¿**:
   - å‡å°‘ç½‘ç»œè·³æ•°ï¼Œé™ä½å»¶è¿Ÿ
   - é¿å… NAT è½¬æ¢çš„æ€§èƒ½å¼€é”€

3. **æ•…éšœæ’æŸ¥ç®€å•**:
   - ç½‘ç»œè·¯å¾„æ¸…æ™°å¯è§
   - é—®é¢˜å®šä½æ›´å®¹æ˜“

4. **æ”¯æŒåŸç”Ÿåè®®**:
   - æ”¯æŒå¤šæ’­ã€å¹¿æ’­ç­‰ç‰¹æ®Šåè®®
   - ä¿æŒç½‘ç»œåè®®çš„å®Œæ•´æ€§

##### 6. **å®é™…éªŒè¯æ‰å¹³ç½‘ç»œ**

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯æ‰å¹³ç½‘ç»œç‰¹æ€§ï¼š

```bash
# 1. æŸ¥çœ‹æ‰€æœ‰ Pod IP (å®ƒä»¬åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´)
kubectl get pods -A -o wide

# 2. ä»ä»»æ„ Pod ping å¦ä¸€ä¸ª Pod (ç›´æ¥ä½¿ç”¨ IP)
kubectl exec pod-a -- ping 10.244.2.20

# 3. æŸ¥çœ‹è·¯ç”±è·¯å¾„ (åº”è¯¥æ˜¯ç›´æ¥è·¯ç”±ï¼Œæ—  NAT)
kubectl exec pod-a -- traceroute 10.244.2.20

# 4. éªŒè¯æ— ç«¯å£æ˜ å°„ (Pod ç«¯å£å°±æ˜¯å®é™…ç«¯å£)
kubectl exec pod-a -- netstat -tlnp
```

##### 7. **æ‰å¹³ç½‘ç»œ vs å…¶ä»–ç½‘ç»œæ¨¡å¼**

| ç½‘ç»œæ¨¡å¼ | åœ°å€è½¬æ¢ | ç½‘ç»œæ€§èƒ½ | å¤æ‚åº¦ | åè®®æ”¯æŒ |
|---------|----------|----------|---------|----------|
| æ‰å¹³ç½‘ç»œ | æ—  | é«˜ | ä½ | å®Œæ•´ |
| NAT ç½‘ç»œ | æœ‰ | ä¸­ç­‰ | ä¸­ç­‰ | å—é™ |
| éš§é“ç½‘ç»œ | å°è£… | ä½ | é«˜ | å®Œæ•´ |

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Kubernetes é€‰æ‹©æ‰å¹³ç½‘ç»œæ¨¡å‹çš„åŸå› â€”â€”å®ƒæä¾›äº†æœ€æ¥è¿‘"è£¸æœº"ç½‘ç»œçš„ä½“éªŒï¼ŒåŒæ—¶ä¿æŒäº†å®¹å™¨åŒ–çš„ä¾¿åˆ©æ€§ã€‚

#### ğŸ” ç½‘ç»œå±‚æ¬¡ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Service                â”‚  â† 4. æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Pod                   â”‚  â† 3. åº”ç”¨å®¹å™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Node                   â”‚  â† 2. ç‰©ç†/è™šæ‹ŸæœºèŠ‚ç‚¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             Cluster                 â”‚  â† 1. é›†ç¾¤ç½‘ç»œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“ å­¦ä¹ ä»»åŠ¡
1. **ç†è§£æ–‡æ¡£**: é˜…è¯» [Kubernetes ç½‘ç»œæ¨¡å‹å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/concepts/cluster-administration/networking/)

2. **å®è·µç»ƒä¹ **: åˆ›å»ºç®€å•çš„ Podï¼Œè§‚å¯Ÿå…¶ç½‘ç»œé…ç½®
   ```bash
   # åˆ›å»ºæµ‹è¯• Pod
   kubectl run test-pod --image=nginx --rm -it -- /bin/bash
   
   # æŸ¥çœ‹ç½‘ç»œæ¥å£
   ip addr show
   
   # æŸ¥çœ‹è·¯ç”±è¡¨
   ip route show
   ```

### Day 3-4: CNI åŸºæœ¬æ¦‚å¿µ

#### ğŸ“– ä»€ä¹ˆæ˜¯ CNI
CNI (Container Network Interface) æ˜¯å®¹å™¨ç½‘ç»œçš„æ ‡å‡†åŒ–æ¥å£ï¼Œå®šä¹‰äº†ï¼š
- å®¹å™¨è¿è¡Œæ—¶å¦‚ä½•è°ƒç”¨ç½‘ç»œæ’ä»¶
- ç½‘ç»œæ’ä»¶å¦‚ä½•é…ç½®å®¹å™¨ç½‘ç»œ
- ç»Ÿä¸€çš„ç½‘ç»œç®¡ç†æ ‡å‡†

#### ğŸ—ï¸ CNI å·¥ä½œæµç¨‹
```
å®¹å™¨åˆ›å»º â†’ è°ƒç”¨ CNI æ’ä»¶ â†’ åˆ†é… IP â†’ é…ç½®ç½‘ç»œæ¥å£ â†’ è®¾ç½®è·¯ç”±
```

#### ğŸ“ å­¦ä¹ ä»»åŠ¡

1. **æŸ¥çœ‹ CNI é…ç½®**:
   ```bash
   # æŸ¥çœ‹ CNI é…ç½®æ–‡ä»¶
   sudo ls /etc/cni/net.d/
   sudo cat /etc/cni/net.d/10-calico.conflist
   ```

2. **ç†è§£ CNI è§„èŒƒ**: é˜…è¯» [CNI å®˜æ–¹è§„èŒƒ](https://github.com/containernetworking/cni)

### Day 5-7: Calico æ¶æ„åŸºç¡€

#### ğŸ“– Calico ç®€ä»‹å¤ä¹ 
Calico æ˜¯ä¸€ä¸ªåŸºäº BGP çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæä¾›ï¼š
- **çº¯ä¸‰å±‚è·¯ç”±**: ä¸ä½¿ç”¨ overlay ç½‘ç»œ
- **é«˜æ€§èƒ½**: æ¥è¿‘åŸç”Ÿç½‘ç»œæ€§èƒ½
- **ç½‘ç»œç­–ç•¥**: ç»†ç²’åº¦çš„å®‰å…¨æ§åˆ¶

#### ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶è¯¦è§£

##### 1. Felix (æ ¸å¿ƒä»£ç†)

```bash
# æŸ¥çœ‹ Felix çŠ¶æ€
kubectl logs -n calico-system -l k8s-app=calico-node | grep felix
```

**ä¸»è¦åŠŸèƒ½**:
- ç›‘å¬ Kubernetes API å˜åŒ–
- ç¼–ç¨‹ Linux å†…æ ¸è·¯ç”±è¡¨
- é…ç½® iptables è§„åˆ™
- æŠ¥å‘ŠèŠ‚ç‚¹å¥åº·çŠ¶æ€

##### 2. BIRD (BGP å®¢æˆ·ç«¯)
```bash
# æŸ¥çœ‹ BGP çŠ¶æ€
kubectl exec -n calico-system <calico-node-pod> -- bird -s
```

**ä¸»è¦åŠŸèƒ½**:
- ä¸å…¶ä»–èŠ‚ç‚¹äº¤æ¢è·¯ç”±ä¿¡æ¯
- ç»´æŠ¤ BGP ä¼šè¯
- ç¡®ä¿è·¯ç”±ä¸€è‡´æ€§

##### 3. CNI æ’ä»¶
**ä¸»è¦åŠŸèƒ½**:
- Pod åˆ›å»ºæ—¶åˆ†é… IP åœ°å€
- é…ç½® veth pair
- è®¾ç½®é»˜è®¤è·¯ç”±

#### ğŸ“ å­¦ä¹ ä»»åŠ¡
1. **æŸ¥çœ‹ç»„ä»¶çŠ¶æ€**:
   ```bash
   # æŸ¥çœ‹ Calico ç›¸å…³ Pod
   kubectl get pods -n calico-system
   
   # æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
   kubectl describe pod -n calico-system <calico-node-pod>
   ```

2. **ç†è§£æ•°æ®æµå‘**:
   ```
   Pod A â†’ veth pair â†’ ä¸»æœºè·¯ç”±è¡¨ â†’ BGP â†’ ç›®æ ‡ä¸»æœº â†’ veth pair â†’ Pod B
   ```

## ğŸ› ï¸ ç¬¬äºŒå‘¨ï¼šå®è·µæ“ä½œ

### Day 8-10: Calico å®‰è£…é…ç½®

#### ğŸš€ ç¯å¢ƒå‡†å¤‡

##### å‰ç½®è¦æ±‚
- Kubernetes é›†ç¾¤ (ç‰ˆæœ¬ 1.20+)
- èŠ‚ç‚¹é—´ç½‘ç»œäº’é€š
- å…³é—­ swap

##### å®‰è£…æ­¥éª¤

**æ–¹æ³•ä¸€: ä½¿ç”¨ Operator (æ¨è)**
```bash
# 1. å®‰è£… Tigera Operator
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml

# 2. ç­‰å¾… Operator å°±ç»ª
kubectl wait --for=condition=Ready pod -l name=tigera-operator -n tigera-operator --timeout=300s

# 3. å®‰è£… Calico
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/custom-resources.yaml
```

**æ–¹æ³•äºŒ: ç›´æ¥å®‰è£…**
```bash
# ç›´æ¥å®‰è£… Calico
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
```

#### âœ… éªŒè¯å®‰è£…

```bash
# 1. æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -n calico-system

# 2. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes -o wide

# 3. éªŒè¯æ‰€æœ‰èŠ‚ç‚¹å°±ç»ª
kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready || echo "æ‰€æœ‰èŠ‚ç‚¹å°±ç»ª"
```

#### ğŸ“ å­¦ä¹ ä»»åŠ¡
1. **å®Œæ•´å®‰è£…æµç¨‹**: åœ¨æµ‹è¯•ç¯å¢ƒå®Œæˆ Calico å®‰è£…
2. **æ•…éšœæ’æŸ¥**: å¦‚æœå®‰è£…å¤±è´¥ï¼Œå­¦ä¼šæŸ¥çœ‹æ—¥å¿—æ’æŸ¥é—®é¢˜
   ```bash
   # æŸ¥çœ‹ Operator æ—¥å¿—
   kubectl logs -n tigera-operator deployment/tigera-operator
   
   # æŸ¥çœ‹ Calico èŠ‚ç‚¹æ—¥å¿—
   kubectl logs -n calico-system -l k8s-app=calico-node
   ```

### Day 11-12: åŸºæœ¬å·¥å…·ä½¿ç”¨

#### ğŸ”§ å®‰è£… calicoctl

```bash
# ä¸‹è½½ calicoctl (Linux)
curl -L https://github.com/projectcalico/calico/releases/latest/download/calicoctl-linux-amd64 -o calicoctl

# è®¾ç½®æ‰§è¡Œæƒé™
chmod +x calicoctl

# ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
sudo mv calicoctl /usr/local/bin/

# éªŒè¯å®‰è£…
calicoctl version
```

#### ğŸ“Š åŸºæœ¬å‘½ä»¤ç»ƒä¹ 

```bash
# 1. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
calicoctl node status

# 2. æŸ¥çœ‹ IP æ± 
calicoctl get ippool -o wide

# 3. æŸ¥çœ‹å·¥ä½œè´Ÿè½½ç«¯ç‚¹
calicoctl get workloadendpoint

# 4. æŸ¥çœ‹ BGP é…ç½®
calicoctl get bgpconfig default -o yaml
```

#### ğŸ“ å­¦ä¹ ä»»åŠ¡
1. **ç†Ÿç»ƒä½¿ç”¨å·¥å…·**: ç»ƒä¹ æ‰€æœ‰åŸºæœ¬å‘½ä»¤
2. **ç†è§£è¾“å‡º**: ç†è§£æ¯ä¸ªå‘½ä»¤è¾“å‡ºçš„å«ä¹‰

### Day 13-14: Pod é—´é€šä¿¡å®è·µ

#### ğŸ§ª åˆ›å»ºæµ‹è¯•ç¯å¢ƒ

```bash
# 1. åˆ›å»ºæµ‹è¯•å‘½åç©ºé—´
kubectl create namespace calico-test

# 2. åˆ›å»ºæµ‹è¯• Pod
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: pod-a
  namespace: calico-test
  labels:
    app: test-app-a
spec:
  containers:
  - name: container-a
    image: nicolaka/netshoot
    command: ["/bin/bash", "-c", "sleep 3600"]
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-b
  namespace: calico-test
  labels:
    app: test-app-b
spec:
  containers:
  - name: container-b
    image: nicolaka/netshoot
    command: ["/bin/bash", "-c", "sleep 3600"]
EOF
```

#### ğŸ” ç½‘ç»œè¿é€šæ€§æµ‹è¯•

```bash
# 1. è·å– Pod IP
kubectl get pods -n calico-test -o wide

# 2. æµ‹è¯• Pod é—´è¿é€šæ€§
POD_B_IP=$(kubectl get pod pod-b -n calico-test -o jsonpath='{.status.podIP}')
kubectl exec -n calico-test pod-a -- ping -c 3 $POD_B_IP

# 3. æµ‹è¯•è·¨èŠ‚ç‚¹é€šä¿¡ (å¦‚æœ Pod åœ¨ä¸åŒèŠ‚ç‚¹)
kubectl exec -n calico-test pod-a -- traceroute $POD_B_IP
```

#### ğŸ”¬ æ·±å…¥åˆ†æç½‘ç»œè·¯å¾„

```bash
# 1. æŸ¥çœ‹è·¯ç”±è¡¨
kubectl exec -n calico-test pod-a -- ip route show

# 2. æŸ¥çœ‹ç½‘ç»œæ¥å£
kubectl exec -n calico-test pod-a -- ip addr show

# 3. åœ¨ä¸»æœºä¸ŠæŸ¥çœ‹è·¯ç”±
# (åœ¨ Pod æ‰€åœ¨çš„èŠ‚ç‚¹æ‰§è¡Œ)
ip route show | grep <pod-ip>
```

#### ğŸ“ å­¦ä¹ ä»»åŠ¡
1. **ç½‘ç»œæµ‹è¯•**: å®Œæˆæ‰€æœ‰è¿é€šæ€§æµ‹è¯•
2. **è·¯å¾„åˆ†æ**: ç†è§£æ•°æ®åŒ…çš„ä¼ è¾“è·¯å¾„
3. **é—®é¢˜æ’æŸ¥**: å¦‚æœé‡åˆ°è¿é€šæ€§é—®é¢˜ï¼Œå­¦ä¼šåˆ†æå’Œè§£å†³

## ğŸ¯ åˆçº§é˜¶æ®µæ€»ç»“

### âœ… åº”è¯¥æŒæ¡çš„æŠ€èƒ½

#### ç†è®ºçŸ¥è¯†
- [x] Kubernetes ç½‘ç»œæ¨¡å‹åŸºæœ¬åŸç†
- [x] CNI çš„ä½œç”¨å’Œå·¥ä½œæœºåˆ¶
- [x] Calico æ¶æ„å’Œæ ¸å¿ƒç»„ä»¶
- [x] BGP è·¯ç”±çš„åŸºæœ¬æ¦‚å¿µ

#### å®è·µæŠ€èƒ½
- [x] åœ¨ Kubernetes é›†ç¾¤ä¸­å®‰è£… Calico
- [x] ä½¿ç”¨ kubectl å’Œ calicoctl åŸºæœ¬å‘½ä»¤
- [x] éªŒè¯ Pod é—´ç½‘ç»œè¿é€šæ€§
- [x] è¿›è¡ŒåŸºæœ¬çš„ç½‘ç»œæ•…éšœæ’æŸ¥

### ğŸ” è‡ªæˆ‘æ£€æµ‹é¢˜

1. **ç†è®ºé¢˜**:
   - Kubernetes ç½‘ç»œæ¨¡å‹çš„ä¸‰ä¸ªåŸºæœ¬è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ
   - CNI åœ¨å®¹å™¨ç½‘ç»œä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ
   - Calico çš„ Felix ç»„ä»¶ä¸»è¦è´Ÿè´£ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ

2. **å®è·µé¢˜**:
   - å¦‚ä½•æ£€æŸ¥ Calico å®‰è£…æ˜¯å¦æˆåŠŸï¼Ÿ
   - å¦‚ä½•æŸ¥çœ‹æŸä¸ª Pod çš„ç½‘ç»œé…ç½®ï¼Ÿ
   - å¦‚ä½•æµ‹è¯•ä¸¤ä¸ª Pod ä¹‹é—´çš„ç½‘ç»œè¿é€šæ€§ï¼Ÿ

### ğŸš€ è¿›å…¥ä¸­çº§é˜¶æ®µçš„å‡†å¤‡

å®Œæˆåˆçº§é˜¶æ®µåï¼Œä½ åº”è¯¥ï¼š
1. **å·©å›ºåŸºç¡€**: ç¡®ä¿ç†è®ºçŸ¥è¯†æ‰å®
2. **å¤šåšå®éªŒ**: åœ¨ä¸åŒç¯å¢ƒä¸­ç»ƒä¹ å®‰è£…å’Œé…ç½®
3. **é˜…è¯»æ–‡æ¡£**: å¼€å§‹å…³æ³¨ Calico çš„é«˜çº§ç‰¹æ€§
4. **å‡†å¤‡è¿›é˜¶**: å¼€å§‹å­¦ä¹ ç½‘ç»œç­–ç•¥å’ŒBGPé…ç½®

## ğŸ“š æ¨èé˜…è¯»

### å¿…è¯»æ–‡æ¡£
- [Kubernetes ç½‘ç»œæ¦‚å¿µ](https://kubernetes.io/docs/concepts/cluster-administration/networking/)
- [Calico å¿«é€Ÿå¼€å§‹](https://docs.projectcalico.org/getting-started/)
- [CNI è§„èŒƒ](https://github.com/containernetworking/cni/blob/master/SPEC.md)

### å‚è€ƒèµ„æ–™
- [Kubernetes ç½‘ç»œæ•…éšœæ’æŸ¥](https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/)
- [Calico æ•…éšœæ’æŸ¥æŒ‡å—](https://docs.projectcalico.org/maintenance/troubleshoot/)

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1: å®‰è£…å Pod æ— æ³•è·å– IP åœ°å€
**A**: æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š
```bash
# æ£€æŸ¥ CNI é…ç½®
ls /etc/cni/net.d/

# æ£€æŸ¥ Calico èŠ‚ç‚¹çŠ¶æ€
kubectl get pods -n calico-system

# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
kubectl logs -n calico-system -l k8s-app=calico-node
```

### Q2: Pod é—´æ— æ³•é€šä¿¡
**A**: é€æ­¥æ’æŸ¥ï¼š
```bash
# 1. æ£€æŸ¥ Pod IP åˆ†é…
kubectl get pods -o wide

# 2. æ£€æŸ¥è·¯ç”±è¡¨
calicoctl node status

# 3. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
kubectl exec <pod-a> -- ping <pod-b-ip>
```

### Q3: å¦‚ä½•é‡ç½® Calico é…ç½®
**A**: æ¸…ç†å’Œé‡æ–°å®‰è£…ï¼š
```bash
# åˆ é™¤ Calico èµ„æº
kubectl delete -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml

# æ¸…ç†èŠ‚ç‚¹é…ç½® (åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œ)
sudo rm -rf /etc/cni/net.d/10-calico.conflist
sudo rm -rf /var/lib/calico/

# é‡æ–°å®‰è£…
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
```

---

*å®Œæˆåˆçº§é˜¶æ®µåï¼Œå»ºè®®ç»§ç»­å­¦ä¹  [Calico ä¸­çº§æŒ‡å—](./intermediate-guide.md)*

*æœ€åæ›´æ–°: 2025å¹´7æœˆ*